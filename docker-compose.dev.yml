name: fastapi-template

networks:
  fastapi-template-network:
    name: fastapi-template-network
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.10.0/24

x-deploy: &gpu-deploy
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

services:
  fastapi-template-api:
    image: fastapi-template-api:latest
    container_name: fastapi-template-api
    build:
      context: .
      dockerfile: docker/Dockerfile
      # target: development
      target: production
    networks:
      - fastapi-template-network
    ports:
      - 8000:8000
    restart: "no"
    security_opt:
      - no-new-privileges:true
    tty: true
    command: ["python", "-m", "app.__main__"]
    env_file:
      - .env
    environment:
      - PORT=8000
      - RELOAD=False
    # For self-hosted Hatchet, use:
    # depends_on:
    #   hatchet-lite:
    #     condition: service_started

  fastapi-template-api-workers-general:
    image: fastapi-template-api-workers-general:latest
    container_name: fastapi-template-api-workers-general
    build:
        context: api-workers-general
        dockerfile: Dockerfile
        # target: development
        target: production
        additional_contexts:
          api-shared: api-shared
    networks:
        - fastapi-template-network
    restart: "no"
    security_opt:
      - no-new-privileges:true
    tty: true
    command: ["python", "-m", "worker.main"]
    env_file:
      - .env
    environment:
      - HATCHET_WORKER_NAME=fastapi-template-api-workers-general
      - HATCHET_WORKER_SLOTS=${WORKER_COUNT:-5}
    # For self-hosted Hatchet, use:
    # depends_on:
    #   hatchet-lite:
    #     condition: service_started

  fastapi-template-api-workers-ml:
    image: fastapi-template-api-workers-ml:latest
    container_name: fastapi-template-api-workers-ml
    build:
        context: api-workers-ml
        dockerfile: Dockerfile
        # target: development
        target: production
        additional_contexts:
          api-shared: api-shared
    networks:
        - fastapi-template-network
    restart: "no"
    security_opt:
      - no-new-privileges:true
    <<: *gpu-deploy
    tty: true
    command: ["python", "-m", "worker.main"]
    env_file:
      - .env
    environment:
      - HATCHET_WORKER_NAME=fastapi-template-api-workers-ml
      - HATCHET_WORKER_SLOTS=${ML_WORKER_COUNT:-3}
    # For self-hosted Hatchet, use:
    # depends_on:
    #   hatchet-lite:
    #     condition: service_started
